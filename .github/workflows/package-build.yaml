name: Stage 2 - Package Building & Publishing

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'sentinel_mas/**'
      - 'pyproject.toml'
  release:
    types: [created, published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version (e.g., 0.1.0)'
        required: false
        type: string

permissions:
  contents: write      # Required for creating releases
  id-token: write      # Required for PyPI trusted publishing
  actions: read        # Required for downloading artifacts

env:
  PYTHON_VERSION: "3.12"
  PACKAGE_NAME: "sentinel-mas"

jobs:
  # ==============================================================================
  # JOB 1: Version Management & Validation
  # ==============================================================================
  version-check:
    name: "Version Management"
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      is_release: ${{ steps.check_release.outputs.is_release }}
      should_publish: ${{ steps.check_publish.outputs.should_publish }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install packaging tools
        run: |
          pip install toml packaging

      - name: Get version from pyproject.toml
        id: get_version
        run: |
          VERSION=$(python -c "import toml; print(toml.load('pyproject.toml')['project']['version'])")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Package version: ${VERSION}"

      - name: Check if this is a release
        id: check_release
        run: |
          if [[ "${{ github.event_name }}" == "release" ]] || [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "ðŸ·ï¸ This is a release build"
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "ðŸ”¨ This is a development build"
          fi

      - name: Validate version format
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-suffix (e.g., 0.1.0 or 0.1.0-alpha)"
            exit 1
          fi
          echo "âœ… Version format valid: $VERSION"

      - name: Check for version conflicts
        if: steps.check_release.outputs.is_release == 'true'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if git rev-parse "v${VERSION}" >/dev/null 2>&1; then
            echo "âš ï¸ Warning: Version v${VERSION} already exists as a git tag"
            echo "Consider bumping the version in pyproject.toml"
          else
            echo "âœ… Version v${VERSION} is new"
          fi

      - name: Determine publish strategy
        id: check_publish
        run: |
          if [[ "${{ steps.check_release.outputs.is_release }}" == "true" ]]; then
            echo "should_publish=pypi" >> $GITHUB_OUTPUT
            echo "ðŸ“¤ Will publish to PyPI"
          else
            echo "should_publish=artifact" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Will upload as GitHub artifact only"
          fi

  # ==============================================================================
  # JOB 2: Build Python Package (Wheel + Source Distribution)
  # ==============================================================================
  build-package:
    name: "Build Python Package"
    runs-on: ubuntu-latest
    needs: version-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install build tools
        run: |
          uv pip install --system build setuptools wheel twine
          echo "âœ… Build tools installed"

      - name: Verify package structure
        run: |
          echo "ðŸ“ Verifying package structure..."
          
          if [ ! -f "pyproject.toml" ]; then
            echo "âŒ pyproject.toml not found"
            exit 1
          fi
          
          if [ ! -d "sentinel_mas" ]; then
            echo "âŒ sentinel_mas package directory not found"
            exit 1
          fi
          
          if [ ! -f "sentinel_mas/__init__.py" ]; then
            echo "âŒ sentinel_mas/__init__.py not found"
            exit 1
          fi
          
          echo "âœ… Package structure verified"

      - name: Create package metadata
        run: |
          mkdir -p .build-metadata
          cat > .build-metadata/build-info.txt << EOF
          Build Information
          ==================
          Package: ${{ env.PACKAGE_NAME }}
          Version: ${{ needs.version-check.outputs.version }}
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Git Commit: ${{ github.sha }}
          Git Ref: ${{ github.ref }}
          Build Type: ${{ needs.version-check.outputs.is_release == 'true' && 'Release' || 'Development' }}
          Python Version: ${{ env.PYTHON_VERSION }}
          EOF
          
          cat .build-metadata/build-info.txt

      - name: Build wheel and source distribution
        run: |
          echo "ðŸ”¨ Building package..."
          python -m build --sdist --wheel --outdir dist/
          echo "âœ… Package built successfully"

      - name: List built packages
        run: |
          echo "ðŸ“¦ Built packages:"
          ls -lh dist/
          
          echo ""
          echo "ðŸ“Š Package details:"
          for file in dist/*; do
            echo "  - $(basename $file) ($(du -h $file | cut -f1))"
          done

      - name: Verify package contents
        run: |
          echo "ðŸ” Verifying wheel contents..."
          
          WHEEL_FILE=$(ls dist/*.whl)
          echo "Inspecting: $WHEEL_FILE"
          
          python -m zipfile -l "$WHEEL_FILE" | head -30
          
          if python -m zipfile -l "$WHEEL_FILE" | grep -q "sentinel_mas"; then
            echo "âœ… Package contains sentinel_mas module"
          else
            echo "âŒ Package does not contain sentinel_mas module"
            exit 1
          fi

      - name: Check package with twine
        run: |
          echo "ðŸ” Running twine check..."
          twine check dist/*
          echo "âœ… Package passed twine validation"

      - name: Generate package hash
        run: |
          echo "ðŸ” Generating package hashes..."
          cd dist
          sha256sum * > SHA256SUMS
          cat SHA256SUMS
          cd ..

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package-${{ needs.version-check.outputs.version }}
          path: |
            dist/*.whl
            dist/*.tar.gz
            dist/SHA256SUMS
            .build-metadata/
          retention-days: 90

      - name: Upload to release assets (if release)
        if: needs.version-check.outputs.is_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.whl
            dist/*.tar.gz
            dist/SHA256SUMS
          tag_name: v${{ needs.version-check.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==============================================================================
  # JOB 3: Test Package Installation
  # ==============================================================================
  test-package:
    name: "Test Package Installation"
    runs-on: ${{ matrix.os }}
    needs: [version-check, build-package]
    
    defaults:
      run:
        shell: bash
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.12"]
    
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download package artifact
        uses: actions/download-artifact@v4
        with:
          name: python-package-${{ needs.version-check.outputs.version }}
          path: artifacts/

      - name: List downloaded files (debug)
        run: |
          echo "ðŸ“ Downloaded artifact structure:"
          find artifacts -type f

      - name: Prepare and install package
        run: |
          WHEEL=$(find artifacts -name "*.whl" -type f | head -1)
          if [ -z "$WHEEL" ]; then
            echo "âŒ No wheel file found!"
            exit 1
          fi
          
          echo "ðŸ“¦ Found wheel: $WHEEL"
          echo "ðŸ“¦ Installing package..."
          pip install "$WHEEL"
          echo "âœ… Package installed"

      - name: Verify basic import
        run: |
          python -c "import sentinel_mas; print('sentinel_mas imported successfully')"

      - name: Verify sub-package imports
        run: |
          python -c "from sentinel_mas.agents import crew; print('sentinel_mas.agents.crew imported')"
          python -c "from sentinel_mas.policy_sentinel import audit; print('sentinel_mas.policy_sentinel.audit imported')"
          python -c "from sentinel_mas.policy_sentinel import audit; print('policy_sentinel.audit imported')"

      - name: Check package version
        run: |
          python -c "
          import pkg_resources
          version = pkg_resources.get_distribution('sentinel-mas').version
          print(f'Installed version: {version}')
          "

      - name: Verify package metadata
        run: |
          pip show sentinel-mas

      - name: Run basic smoke tests
        run: |
          python -c "
          import sentinel_mas
          from sentinel_mas import agents
          from sentinel_mas import policy_sentinel
          from sentinel_mas import tools
          print('All smoke tests passed')
          "

      - name: Test package uninstall
        run: |
          pip uninstall -y sentinel-mas
          echo "Package uninstalled successfully"

  # ==============================================================================
  # JOB 4: Publish to PyPI (Release Only)
  # ==============================================================================
  publish-pypi:
    name: "Publish to PyPI"
    runs-on: ubuntu-latest
    needs: [version-check, build-package, test-package]
    if: needs.version-check.outputs.is_release == 'true'
    environment:
      name: pypi
      url: https://pypi.org/p/sentinel-mas
    permissions:
      id-token: write
      contents: write
    
    steps:
      - name: Download package artifact
        uses: actions/download-artifact@v4
        with:
          name: python-package-${{ needs.version-check.outputs.version }}
          path: artifacts/

      - name: Prepare packages for publishing
        run: |
          # Create clean dist directory
          mkdir -p dist
          
          # Copy only .whl and .tar.gz files (not directories)
          find artifacts -name "*.whl" -type f -exec cp {} dist/ \;
          find artifacts -name "*.tar.gz" -type f -exec cp {} dist/ \;
          
          # Verify files exist
          echo "ðŸ“¦ Files prepared for publishing:"
          ls -lh dist/
          
          # Ensure we have files
          if [ -z "$(ls -A dist/)" ]; then
            echo "âŒ No package files found!"
            exit 1
          fi

      - name: Publish to PyPI (Trusted Publishing)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          skip-existing: true
          verbose: true

      - name: Create PyPI link comment
        if: github.event_name == 'release'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.version-check.outputs.version }}';
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `ðŸ“¦ **Package Published to PyPI**\n\n` +
                    `Version: \`${version}\`\n` +
                    `Install with: \`pip install sentinel-mas==${version}\`\n\n` +
                    `[View on PyPI](https://pypi.org/project/sentinel-mas/${version}/)`
            });

  # ==============================================================================
  # JOB 5: Publish to Test PyPI (Development)
  # ==============================================================================
  publish-test-pypi:
    name: "Publish to Test PyPI"
    runs-on: ubuntu-latest
    needs: [version-check, build-package, test-package]
    if: needs.version-check.outputs.is_release == 'false' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    environment:
      name: test-pypi
      url: https://test.pypi.org/p/sentinel-mas
    permissions:
      id-token: write
    
    steps:
      - name: Download package artifact
        uses: actions/download-artifact@v4
        with:
          name: python-package-${{ needs.version-check.outputs.version }}
          path: artifacts/

      - name: Prepare packages for publishing
        run: |
          mkdir -p dist
          find artifacts -name "*.whl" -type f -exec cp {} dist/ \;
          find artifacts -name "*.tar.gz" -type f -exec cp {} dist/ \;
          echo "ðŸ“¦ Files prepared for publishing:"
          ls -lh dist/

      - name: Publish to Test PyPI (Optional)
        uses: pypa/gh-action-pypi-publish@release/v1
        continue-on-error: true
        with:
          repository-url: https://test.pypi.org/legacy/
          packages-dir: dist/
          skip-existing: true
          verbose: true

  # ==============================================================================
  # JOB 6: Generate Release Notes
  # ==============================================================================
  release-notes:
    name: "Generate Release Notes"
    runs-on: ubuntu-latest
    needs: [version-check, build-package]
    if: needs.version-check.outputs.is_release == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download package artifact
        uses: actions/download-artifact@v4
        with:
          name: python-package-${{ needs.version-check.outputs.version }}
          path: artifacts/

      - name: Generate changelog
        run: |
          VERSION="${{ needs.version-check.outputs.version }}"
          
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          echo "# Release Notes - v${VERSION}" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ðŸ“¦ Installation" >> RELEASE_NOTES.md
          echo '```bash' >> RELEASE_NOTES.md
          echo "pip install sentinel-mas==${VERSION}" >> RELEASE_NOTES.md
          echo '```' >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          
          if [ ! -z "$PREV_TAG" ]; then
            echo "## ðŸ“ Changes since ${PREV_TAG}" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges >> RELEASE_NOTES.md
          fi
          
          echo "" >> RELEASE_NOTES.md
          echo "## ðŸ“Š Package Details" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "**Files:**" >> RELEASE_NOTES.md
          find artifacts -name "*.whl" -o -name "*.tar.gz" | while read file; do
            SIZE=$(du -h "$file" | cut -f1)
            echo "- $(basename $file) ($SIZE)" >> RELEASE_NOTES.md
          done
          
          echo "" >> RELEASE_NOTES.md
          echo "**Checksums:**" >> RELEASE_NOTES.md
          echo '```' >> RELEASE_NOTES.md
          if [ -f artifacts/SHA256SUMS ]; then
            cat artifacts/SHA256SUMS >> RELEASE_NOTES.md
          fi
          echo '```' >> RELEASE_NOTES.md
          
          cat RELEASE_NOTES.md

      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: RELEASE_NOTES.md
          retention-days: 90

  # ==============================================================================
  # JOB 7: Status Summary
  # ==============================================================================
  package-status:
    name: "Package Build Status"
    runs-on: ubuntu-latest
    needs: [version-check, build-package, test-package]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ“¦ Package Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version Check | ${{ needs.version-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Package Build | ${{ needs.build-package.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Package Test | ${{ needs.test-package.result }} |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.version-check.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Type:** ${{ needs.version-check.outputs.is_release == 'true' && 'Release' || 'Development' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Publish Target:** ${{ needs.version-check.outputs.should_publish }}" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.build-package.result }}" == "success" ]] && [[ "${{ needs.test-package.result }}" == "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Package build completed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¥ Download artifact: \`python-package-${{ needs.version-check.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Package build failed. Check job logs for details.**" >> $GITHUB_STEP_SUMMARY
          fi

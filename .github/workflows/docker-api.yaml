name: Stage 3 - Build API Docker Image

on:
  workflow_run:
    workflows: ["Stage 2 - Package Building & Publishing"]
    types: [completed]
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      sentinel_version:
        description: 'sentinel-mas version'
        required: false
        default: 'latest'

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: sentinel-mas-api

jobs:
  build-and-push:
    name: "Build & Push API Image"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: Get sentinel-mas version
        id: get_version
        run: |
          if [ "${{ github.event.inputs.sentinel_version }}" == "latest" ] || [ -z "${{ github.event.inputs.sentinel_version }}" ]; then
            VERSION=$(python -c "import toml; print(toml.load('pyproject.toml')['project']['version'])")
          else
            VERSION="${{ github.event.inputs.sentinel_version }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Using sentinel-mas version: ${VERSION}"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.get_version.outputs.version }}
        run: |
          cd api_service
          docker build \
            --build-arg SENTINEL_VERSION=${{ steps.get_version.outputs.version }} \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:${{ github.sha }} \
            .
          echo "âœ… Docker image built successfully"
      
      - name: Test image locally
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.get_version.outputs.version }}
        run: |
          # Test that image runs
          docker run -d --name test-api \
            -e ENVIRONMENT=development \
            -p 8000:8000 \
            $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          
          # Wait for startup
          sleep 10
          
          # Test health endpoint
          curl -f http://localhost:8000/health || exit 1
          
          # Cleanup
          docker stop test-api
          docker rm test-api
          
          echo "âœ… Image test passed"
      
      - name: Scan image for vulnerabilities
        continue-on-error: true
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.get_version.outputs.version }}
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image \
            --severity HIGH,CRITICAL \
            --exit-code 0 \
            $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
      
      - name: Push to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.get_version.outputs.version }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${{ github.sha }}
          echo "âœ… Images pushed to ECR"
      
      - name: Output image details
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.get_version.outputs.version }}
        run: |
          echo "## ðŸ³ Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** $ECR_REPOSITORY" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** $ECR_REGISTRY" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`$ECR_REGISTRY/$ECR_REPOSITORY:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`$ECR_REGISTRY/$ECR_REPOSITORY:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull command:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY